<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FlightBag</title>
  <style>
    :root{
      --bg:#050607;
      --panel:#0b0d0f;
      --panel2:#0f1215;
      --line:#20262c;
      --txt:#e6eef7;
      --muted:#9aa8b8;
      --green:#29d36a;
      --cyan:#28c3ff;
      --orange:#ff9d2e;
      --danger:#ff4d4d;
      --btn:#151a20;
      --btn2:#1b222a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--txt);
    }

    /* --- App shell: left vertical menu + content --- */
    .shell{
      height:100vh;
      display:grid;
      grid-template-columns: 108px 1fr;
      gap:12px;
      padding:12px;
    }

    /* Left vertical menu */
    .sidebar{
      background: linear-gradient(180deg, rgba(10,12,14,.98), rgba(10,12,14,.85));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;
      min-height:0;
    }
    .logo{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 8px;
      text-align:center;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.8px;
      text-transform:uppercase;
      user-select:none;
      background: rgba(255,255,255,.02);
    }

    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      padding-right:2px;
    }

    button, input, select, textarea{ font:inherit; }

    .navbtn{
      width:100%;
      min-height:64px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      color:var(--muted);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      user-select:none;
    }
    .navbtn:hover{ background: rgba(255,255,255,.04); }
    .navbtn.active{
      color:var(--txt);
      border-color:#2a3a4a;
      background: rgba(255,255,255,.05);
    }
    .navicon{ font-size:18px; line-height:1; opacity:.95; }
    .navlabel{ font-size:11px; letter-spacing:.8px; text-transform:uppercase; }

    .sidebarFooter{
      margin-top:auto;
      border-top:1px solid var(--line);
      padding-top:10px;
      color:var(--muted);
      font-size:11px;
      text-align:center;
      line-height:1.3;
    }

    /* Content area */
    .content{
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* --- TOP WIDGET BAR (sticky) --- */
    .topWidgets{
      position: sticky;
      top: 12px;
      z-index: 50;
      background: linear-gradient(180deg, rgba(10,12,14,.96), rgba(10,12,14,.85));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter: blur(8px);
    }
    .topWidgets .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex-wrap:wrap;
    }
    .topWidgets .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      min-height:36px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .mono{
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
      letter-spacing:.4px;
      color:var(--txt);
      font-size:13px;
    }
    .depInput{
      border:none;
      background:transparent;
      color:var(--txt);
      outline:none;
      font-size:13px;
      padding:0;
      min-height:24px;
      width:110px;
    }
    .muted{ color:var(--muted); font-size:12px; }

    /* Views */
    .view{
      display:none;
      min-height:0;
      flex:1;
    }
    .view.active{ display:block; }

    /* Home cards */
    .home{
      height:100%;
      min-height:0;
      display:grid;
      grid-template-columns: repeat(3, minmax(220px, 1fr));
      gap:14px;
      align-content:start;
      padding:6px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      padding:16px;
      min-height:160px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0;
      font-size:18px;
      letter-spacing:.6px;
      text-transform:uppercase;
    }
    .card p{
      margin:8px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    /* Generic button */
    .btn{
      background:var(--btn);
      color:var(--txt);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      cursor:pointer;
      min-height:44px;
    }
    .btn:hover{ background:var(--btn2); }
    .btn.primary{ border-color:#2a3a4a; }
    .btn.danger{ border-color:#5a2424; color:#ffd4d4; }
    .btn.small{ padding:9px 12px; min-height:36px; border-radius:999px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      min-height:40px;
      color:var(--muted);
      font-size:12px;
    }

    /* Departure layout (3 columns) */
    .app{
      height:100%;
      min-height:0;
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap:12px;
      padding:6px;
    }
    .panel{
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      box-shadow: var(--shadow);
    }
    header{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    header .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    header h1{
      margin:0;
      font-size:16px;
      letter-spacing:.6px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    header .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .toolbar{
      padding:10px 14px;
      display:flex;
      gap:8px;
      align-items:center;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .list{
      padding:10px 10px 14px;
      overflow:auto;
      min-height:0;
    }
    .item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(255,255,255,.02);
      margin:10px 0;
    }
    .check{
      width:26px;height:26px;
      border-radius:8px;
      border:2px solid #2b3a48;
      background:transparent;
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .check.done{
      border-color: rgba(41,211,106,.45);
      background: rgba(41,211,106,.14);
    }
    .check svg{ width:16px;height:16px; opacity:0; }
    .check.done svg{ opacity:1; fill: var(--green); }

    .item-main{ flex:1 1 auto; min-width:0; }
    .item-name{
      font-size:16px;
      letter-spacing:.3px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item-meta{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
    }
    .tag.g{ color:var(--green); }
    .tag.c{ color:var(--cyan); }
    .tag.o{ color:var(--orange); }
    .actions{ display:flex; gap:8px; flex:0 0 auto; }

    .widget{ padding:12px 14px; border-bottom:1px solid var(--line); }
    textarea{
      width:100%;
      min-height:180px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      padding:12px;
      outline:none;
      font-size:14px;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(620px, 100%);
      background: #0c0f12;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .modal header{ border-bottom:1px solid var(--line); }
    .modal-body{ padding:14px; display:grid; gap:10px; }
    .row{ display:grid; grid-template-columns: 1fr 180px; gap:10px; }
    .field label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    .field input, .field select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--txt);
      padding:12px;
      min-height:44px;
      outline:none;
    }
    .modal-footer{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }

    @media (max-width: 1100px){
      .shell{ grid-template-columns: 1fr; }
      .sidebar{ flex-direction:row; align-items:center; }
      .nav{ flex-direction:row; overflow:auto; }
      .navbtn{ min-width:120px; min-height:56px; }
      .sidebarFooter{ display:none; }
      .home{ grid-template-columns: 1fr; }
      .app{ grid-template-columns: 1fr; height:auto; }
      .topWidgets{ top:12px; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <!-- LEFT VERTICAL MENU -->
    <aside class="sidebar">
      <div class="logo">FlightBag</div>

      <nav class="nav">
        <button class="navbtn" data-route="#home">
          <div class="navicon">‚åÇ</div>
          <div class="navlabel">Home</div>
        </button>

        <button class="navbtn" data-route="#departure">
          <div class="navicon">üõ´</div>
          <div class="navlabel">Departure</div>
        </button>

        <button class="navbtn" data-route="#cruise">
          <div class="navicon">‚úàÔ∏è</div>
          <div class="navlabel">Cruise</div>
        </button>

        <button class="navbtn" data-route="#arrival">
          <div class="navicon">üõ¨</div>
          <div class="navlabel">Arrival</div>
        </button>

        <button class="navbtn" data-route="#notes">
          <div class="navicon">üìù</div>
          <div class="navlabel">Notes</div>
        </button>
      </nav>

      <div class="sidebarFooter">
        iPad ‚Ä¢ Offline Ready<br/>
        Widgets + Countdown
      </div>
    </aside>

    <!-- CONTENT -->
    <main class="content">
      <!-- TOP STICKY WIDGETS (UTC + Departure input + Countdown) -->
      <div class="topWidgets" id="topWidgets">
        <div class="left">
          <span class="chip">UTC <span class="mono" id="utcMini">--:--:--</span></span>

          <span class="chip">
            DEP (UTC)
            <input id="depTimeUtc" class="depInput" type="time" />
          </span>
        </div>

        <div class="right">
          <button class="btn small primary" id="setDepTimeBtn">Set</button>
          <button class="btn small danger" id="clearDepTimeBtn">Clear</button>

          <span class="chip">T-DEP <span class="mono" id="countMini">--:--:--</span></span>
          <span class="chip"><span class="muted" id="countStatusMini">No departure time set.</span></span>
        </div>
      </div>

      <!-- HOME -->
      <section class="view" id="view-home">
        <div class="home">
          <div class="card">
            <div>
              <h2>Departure</h2>
              <p>Pre-flight items, briefing, fuel, NOTOC, timers, scratchpad.</p>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:14px;">
              <button class="btn primary" onclick="go('#departure')">Open</button>
            </div>
          </div>

          <div class="card">
            <div>
              <h2>Cruise</h2>
              <p>Cruise checks, time markers, notes, abnormal quick access.</p>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:14px;">
              <button class="btn primary" onclick="go('#cruise')">Open</button>
            </div>
          </div>

          <div class="card">
            <div>
              <h2>Arrival</h2>
              <p>Arrival briefing, approach setup, landing performance, checklist.</p>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:14px;">
              <button class="btn primary" onclick="go('#arrival')">Open</button>
            </div>
          </div>
        </div>
      </section>

      <!-- DEPARTURE -->
      <section class="view" id="view-departure">
        <div class="app">
          <!-- Left: Pre-flight -->
          <section class="panel">
            <header>
              <div class="title">
                <h1>Departure ‚Ä¢ Pre-Flight</h1>
                <div class="sub">Toque para Done ‚Ä¢ Edit/Add dispon√≠vel</div>
              </div>
              <div class="pill" id="progressPill">0/0 done</div>
            </header>

            <div class="toolbar">
              <button class="btn primary" id="addBtn">+ Add item</button>
              <button class="btn" id="resetBtn">Reset all</button>
              <button class="btn danger" id="factoryBtn">Factory defaults</button>
            </div>

            <div class="list" id="list"></div>
          </section>

          <!-- Center -->
          <section class="panel">
            <header>
              <div class="title">
                <h1>Departure ‚Ä¢ Sections</h1>
                <div class="sub">Pr√≥ximo: Fuel / Briefing / Security / Timers</div>
              </div>
            </header>

            <div class="widget">
              <div class="muted">Vamos adicionar bot√µes aqui (estilo seu mockup):</div>
              <ul style="margin:10px 0 0; color:var(--muted); line-height:1.7;">
                <li><b>Fuel</b>: SG, figures, cross-checks</li>
                <li><b>Briefing</b>: threats/mitigations, runway, WX</li>
                <li><b>Security</b>: check form</li>
                <li><b>Timers</b>: departure time + countdown</li>
              </ul>
            </div>
          </section>

          <!-- Right: Scratchpad only -->
          <section class="panel">
            <header>
              <div class="title">
                <h1>Utilities</h1>
                <div class="sub">Scratchpad (persisted)</div>
              </div>
            </header>

            <div class="widget">
              <div class="muted">Scratchpad</div>
              <textarea id="scratch" placeholder="Type notes here‚Ä¶"></textarea>
            </div>
          </section>
        </div>
      </section>

      <!-- CRUISE -->
      <section class="view" id="view-cruise">
        <div class="home">
          <div class="card" style="grid-column: 1 / -1;">
            <div>
              <h2>Cruise</h2>
              <p>Placeholder. Depois criamos com checklist + utilities.</p>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:14px;">
              <button class="btn" onclick="go('#home')">Back to Home</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ARRIVAL -->
      <section class="view" id="view-arrival">
        <div class="home">
          <div class="card" style="grid-column: 1 / -1;">
            <div>
              <h2>Arrival</h2>
              <p>Placeholder. Depois criamos Arrival briefing + approach setup.</p>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:14px;">
              <button class="btn" onclick="go('#home')">Back to Home</button>
            </div>
          </div>
        </div>
      </section>

      <!-- NOTES -->
      <section class="view" id="view-notes">
        <div class="home">
          <div class="card" style="grid-column: 1 / -1;">
            <div>
              <h2>Notes</h2>
              <p>Notas gerais (persistidas). Podemos separar por voo depois.</p>
            </div>
            <div style="margin-top:12px;">
              <textarea id="notesArea" placeholder="General notes‚Ä¶"></textarea>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL (add/edit checklist item) -->
  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <div class="title">
          <h1 id="modalTitle">Add item</h1>
          <div class="sub" id="modalSub">Create checklist item</div>
        </div>
        <button class="btn small" id="closeModal">Close</button>
      </header>

      <div class="modal-body">
        <div class="field">
          <label for="nameInput">Item name</label>
          <input id="nameInput" type="text" maxlength="40" placeholder="e.g., Fuel Figures - CTL & ENG" />
        </div>

        <div class="row">
          <div class="field">
            <label for="noteInput">Note (optional)</label>
            <input id="noteInput" type="text" maxlength="60" placeholder="e.g., Compare with OFP / EFB" />
          </div>

          <div class="field">
            <label for="colorSelect">Color</label>
            <select id="colorSelect">
              <option value="green">Green (done/ok)</option>
              <option value="cyan">Cyan (flow)</option>
              <option value="orange">Orange (consider)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn danger" id="deleteBtn" style="display:none;">Delete</button>
        <button class="btn primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

<script>
  // ---------------- Router (hash-based) ----------------
  const LAST_ROUTE_KEY = "flightbag_last_route_v1";
  function go(hash){ location.hash = hash; }

  function setRoute(hash){
    const route = hash || "#home";
    localStorage.setItem(LAST_ROUTE_KEY, route);

    const map = {
      "#home": "view-home",
      "#departure": "view-departure",
      "#cruise": "view-cruise",
      "#arrival": "view-arrival",
      "#notes": "view-notes",
    };
    const viewId = map[route] || map["#home"];

    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    document.getElementById(viewId).classList.add("active");

    document.querySelectorAll(".navbtn").forEach(b => {
      b.classList.toggle("active", b.dataset.route === route);
    });
  }

  document.querySelectorAll(".navbtn").forEach(btn => {
    btn.addEventListener("click", () => go(btn.dataset.route));
  });

  window.addEventListener("hashchange", () => setRoute(location.hash));

  const saved = localStorage.getItem(LAST_ROUTE_KEY);
  if(!location.hash){
    location.hash = saved || "#home";
  }
  setRoute(location.hash);

  // ---------------- Small UTC widget ----------------
  const utcMini = document.getElementById("utcMini");
  function tickUtc(){
    const d = new Date();
    const hh = String(d.getUTCHours()).padStart(2,"0");
    const mm = String(d.getUTCMinutes()).padStart(2,"0");
    const ss = String(d.getUTCSeconds()).padStart(2,"0");
    if(utcMini) utcMini.textContent = `${hh}:${mm}:${ss}`;
  }
  setInterval(tickUtc, 250);
  tickUtc();

  // ---------------- Scratchpad + Notes persistence ----------------
  const SCRATCH_KEY = "flightbag_scratch_v1";
  const scratch = document.getElementById("scratch");
  if(scratch){
    scratch.value = localStorage.getItem(SCRATCH_KEY) || "";
    scratch.addEventListener("input", () => localStorage.setItem(SCRATCH_KEY, scratch.value));
  }

  const NOTES_KEY = "flightbag_notes_v1";
  const notesArea = document.getElementById("notesArea");
  if(notesArea){
    notesArea.value = localStorage.getItem(NOTES_KEY) || "";
    notesArea.addEventListener("input", () => localStorage.setItem(NOTES_KEY, notesArea.value));
  }

  // ---------------- Pre-Flight checklist (Departure) ----------------
  const STORAGE_KEY = "flightbag_departure_preflight_items_v1";

  const FACTORY_DEFAULTS = [
    { id: crypto.randomUUID(), name:"Brakes Temp", color:"green", note:"", done:false },
    { id: crypto.randomUUID(), name:"Batt Check / ADIRs", color:"green", note:"", done:false },
    { id: crypto.randomUUID(), name:"Power Up", color:"green", note:"", done:false },
    { id: crypto.randomUUID(), name:"OIS", color:"green", note:"", done:false },
    { id: crypto.randomUUID(), name:"Tech Log / MEL", color:"green", note:"", done:false },
    { id: crypto.randomUUID(), name:"A/C Conf. Diff / OEBs", color:"green", note:"", done:false },
    { id: crypto.randomUUID(), name:"APU / ENG Fire Tested", color:"green", note:"", done:false },
    { id: crypto.randomUUID(), name:"Fuel Figures - CTL & ENG", color:"green", note:"Cross-check", done:false },
    { id: crypto.randomUUID(), name:"Briefing Done", color:"green", note:"Threats / mitigations", done:false },
    { id: crypto.randomUUID(), name:"NOTOC", color:"cyan", note:"Cargo/ULD info", done:false },
    { id: crypto.randomUUID(), name:"ATC CLR", color:"cyan", note:"IFPS / SID", done:false },
    { id: crypto.randomUUID(), name:"APU Start - Consider", color:"orange", note:"Gate / SOP", done:false },
  ];

  let items = loadItems();
  let editingId = null;

  const listEl = document.getElementById("list");
  const progressPill = document.getElementById("progressPill");

  const addBtn = document.getElementById("addBtn");
  const resetBtn = document.getElementById("resetBtn");
  const factoryBtn = document.getElementById("factoryBtn");

  const backdrop = document.getElementById("backdrop");
  const closeModal = document.getElementById("closeModal");
  const saveBtn = document.getElementById("saveBtn");
  const deleteBtn = document.getElementById("deleteBtn");

  const nameInput = document.getElementById("nameInput");
  const noteInput = document.getElementById("noteInput");
  const colorSelect = document.getElementById("colorSelect");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");

  render();

  if(addBtn) addBtn.addEventListener("click", () => openModalForCreate());
  if(resetBtn) resetBtn.addEventListener("click", () => {
    items = items.map(it => ({...it, done:false}));
    saveItems(items);
    render();
  });
  if(factoryBtn) factoryBtn.addEventListener("click", () => {
    items = structuredClone(FACTORY_DEFAULTS);
    saveItems(items);
    render();
  });

  if(closeModal) closeModal.addEventListener("click", closeModalFn);
  if(backdrop) backdrop.addEventListener("click", (e) => { if(e.target === backdrop) closeModalFn(); });

  if(saveBtn) saveBtn.addEventListener("click", () => {
    const name = nameInput.value.trim();
    if(!name){ nameInput.focus(); return; }
    const note = noteInput.value.trim();
    const color = colorSelect.value;

    if(editingId){
      items = items.map(it => it.id === editingId ? ({...it, name, note, color}) : it);
    } else {
      items = [{ id: crypto.randomUUID(), name, note, color, done:false }, ...items];
    }
    saveItems(items);
    render();
    closeModalFn();
  });

  if(deleteBtn) deleteBtn.addEventListener("click", () => {
    if(!editingId) return;
    items = items.filter(it => it.id !== editingId);
    saveItems(items);
    render();
    closeModalFn();
  });

  function render(){
    if(!listEl || !progressPill) return;

    listEl.innerHTML = "";
    const doneCount = items.filter(i => i.done).length;
    progressPill.textContent = `${doneCount}/${items.length} done`;

    if(items.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.padding = "16px";
      empty.textContent = "No items yet. Tap ‚ÄúAdd item‚Äù.";
      listEl.appendChild(empty);
      return;
    }

    for(const it of items){
      const row = document.createElement("div");
      row.className = "item";

      const check = document.createElement("div");
      check.className = "check" + (it.done ? " done":"");
      check.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z"></path>
        </svg>
      `;
      check.addEventListener("click", () => {
        items = items.map(x => x.id === it.id ? ({...x, done: !x.done}) : x);
        saveItems(items);
        render();
      });

      const main = document.createElement("div");
      main.className = "item-main";

      const name = document.createElement("div");
      name.className = "item-name";
      name.textContent = it.name;

      const meta = document.createElement("div");
      meta.className = "item-meta";

      const tag = document.createElement("span");
      tag.className = "tag " + (it.color === "green" ? "g" : it.color === "cyan" ? "c" : "o");
      tag.textContent = it.color.toUpperCase();
      meta.appendChild(tag);

      if(it.note){
        const note = document.createElement("span");
        note.className = "tag";
        note.textContent = it.note;
        meta.appendChild(note);
      }

      main.appendChild(name);
      main.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "actions";

      const edit = document.createElement("button");
      edit.className = "btn small";
      edit.textContent = "Edit";
      edit.addEventListener("click", () => openModalForEdit(it.id));
      actions.appendChild(edit);

      row.appendChild(check);
      row.appendChild(main);
      row.appendChild(actions);

      listEl.appendChild(row);
    }
  }

  function openModalForCreate(){
    editingId = null;
    modalTitle.textContent = "Add item";
    modalSub.textContent = "Create checklist item";
    deleteBtn.style.display = "none";
    nameInput.value = "";
    noteInput.value = "";
    colorSelect.value = "green";
    openModal();
    setTimeout(() => nameInput.focus(), 50);
  }

  function openModalForEdit(id){
    const it = items.find(x => x.id === id);
    if(!it) return;
    editingId = id;
    modalTitle.textContent = "Edit item";
    modalSub.textContent = "Update checklist item";
    deleteBtn.style.display = "inline-block";
    nameInput.value = it.name;
    noteInput.value = it.note || "";
    colorSelect.value = it.color || "green";
    openModal();
    setTimeout(() => nameInput.focus(), 50);
  }

  function openModal(){
    backdrop.classList.add("show");
    backdrop.setAttribute("aria-hidden","false");
  }
  function closeModalFn(){
    backdrop.classList.remove("show");
    backdrop.setAttribute("aria-hidden","true");
  }

  function loadItems(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(FACTORY_DEFAULTS);
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed)) return structuredClone(FACTORY_DEFAULTS);
      return parsed;
    } catch {
      return structuredClone(FACTORY_DEFAULTS);
    }
  }
  function saveItems(next){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
  }

  // ---------------- Departure Countdown (UTC) + top widget ----------------
  const DEP_KEY = "flightbag_departure_time_utc_v1";
  const depTimeUtc = document.getElementById("depTimeUtc");
  const setDepTimeBtn = document.getElementById("setDepTimeBtn");
  const clearDepTimeBtn = document.getElementById("clearDepTimeBtn");

  const countMini = document.getElementById("countMini");
  const countStatusMini = document.getElementById("countStatusMini");

  function pad2(n){ return String(n).padStart(2,"0"); }

  function timeToSeconds(t){
    if(!t) return null;
    const parts = t.split(":").map(Number);
    if(parts.length < 2) return null;
    const hh = parts[0] || 0;
    const mm = parts[1] || 0;
    const ss = parts[2] || 0;
    return (hh*3600) + (mm*60) + ss;
  }

  function buildUtcDateForToday(seconds){
    const now = new Date();
    const y = now.getUTCFullYear();
    const m = now.getUTCMonth();
    const d = now.getUTCDate();
    const hh = Math.floor(seconds/3600);
    const mm = Math.floor((seconds%3600)/60);
    const ss = seconds%60;
    return new Date(Date.UTC(y, m, d, hh, mm, ss));
  }

  function formatHMS(totalSeconds){
    const s = Math.max(0, Math.floor(totalSeconds));
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }

  function loadDepartureTime(){
    const raw = localStorage.getItem(DEP_KEY);
    if(!raw) return null;
    try{
      const obj = JSON.parse(raw);
      if(!obj || typeof obj.time !== "string") return null;
      return obj.time; // "HH:MM"
    } catch { return null; }
  }

  function saveDepartureTime(timeStr){
    localStorage.setItem(DEP_KEY, JSON.stringify({ time: timeStr }));
  }

  function clearDepartureTime(){
    localStorage.removeItem(DEP_KEY);
  }

  function updateCountdown(){
    const saved = loadDepartureTime();

    if(!saved){
      if(countMini) countMini.textContent = "--:--:--";
      if(countStatusMini) countStatusMini.textContent = "No departure time set.";
      return;
    }

    if(depTimeUtc && depTimeUtc.value !== saved) depTimeUtc.value = saved;

    const depSec = timeToSeconds(saved);
    if(depSec === null){
      if(countMini) countMini.textContent = "--:--:--";
      if(countStatusMini) countStatusMini.textContent = "Invalid time format.";
      return;
    }

    let depDate = buildUtcDateForToday(depSec);
    const now = new Date();

    // If already passed today (UTC), assume next day
    if(depDate.getTime() < now.getTime()){
      depDate = new Date(depDate.getTime() + 24*3600*1000);
    }

    const diffSec = (depDate.getTime() - now.getTime()) / 1000;
    if(countMini) countMini.textContent = formatHMS(diffSec);
    if(countStatusMini) countStatusMini.textContent = `Departure set to ${saved} UTC`;
  }

  if(setDepTimeBtn){
    setDepTimeBtn.addEventListener("click", () => {
      if(!depTimeUtc) return;
      const t = depTimeUtc.value;
      if(!t){ depTimeUtc.focus(); return; }
      const normalized = t.slice(0,5); // HH:MM
      saveDepartureTime(normalized);
      updateCountdown();
    });
  }

  if(clearDepTimeBtn){
    clearDepTimeBtn.addEventListener("click", () => {
      clearDepartureTime();
      if(depTimeUtc) depTimeUtc.value = "";
      updateCountdown();
    });
  }

  // init from storage
  const savedDep = loadDepartureTime();
  if(depTimeUtc && savedDep) depTimeUtc.value = savedDep;

  setInterval(updateCountdown, 1000);
  updateCountdown();
</script>
</body>
</html>
